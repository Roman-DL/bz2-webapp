<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ë–∞–∑–∞ –ó–Ω–∞–Ω–∏–π 2.0 - –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è (–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞)</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <!-- –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê CSS –ó–ê–ì–†–£–ó–ö–ò -->
    <link rel="stylesheet" href="../assets/css/bz2-common.css" id="mainCSS">
    
    <!-- FALLBACK –°–¢–ò–õ–ò (–µ—Å–ª–∏ CSS –Ω–µ –∑–∞–≥—Ä—É–∑–∏—Ç—Å—è) -->
    <style id="fallbackStyles">
        /* –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ –Ω–∞ —Å–ª—É—á–∞–π –ø—Ä–æ–±–ª–µ–º —Å CSS */
        body {
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            background-color: #1e2235;
            color: white;
            padding: 20px;
            margin: 0;
        }
        
        .container {
            max-width: 400px;
            margin: 0 auto;
            background-color: #2d2f50;
            padding: 20px;
            border-radius: 8px;
        }
        
        .title { 
            color: #f9b17a; 
            text-align: center; 
            margin-bottom: 20px;
        }
        
        .form-group { 
            margin-bottom: 15px; 
        }
        
        .form-group label { 
            display: block; 
            color: #f9b17a; 
            margin-bottom: 5px; 
        }
        
        .form-group input { 
            width: 100%; 
            padding: 10px; 
            background-color: #424769; 
            border: none; 
            border-radius: 4px; 
            color: white;
            box-sizing: border-box;
        }
        
        .submit-btn { 
            background-color: #f9b17a; 
            color: #2d2f50; 
            border: none; 
            padding: 12px 20px; 
            border-radius: 4px; 
            cursor: pointer;
            width: 100%;
            font-size: 16px;
            margin-top: 10px;
        }
        
        .cancel-btn { 
            background-color: #6b7280; 
            color: white; 
            border: none; 
            padding: 10px 20px; 
            border-radius: 4px; 
            cursor: pointer;
            width: 100%;
            margin-top: 10px;
        }
        
        .diagnostic { 
            position: fixed; 
            top: 10px; 
            left: 10px; 
            background: rgba(0,0,0,0.9); 
            color: white; 
            padding: 10px; 
            font-size: 12px; 
            border-radius: 4px; 
            z-index: 9999;
            max-width: 300px;
        }
        
        .telegram-note { 
            background: #ebf8ff; 
            color: #2b6cb0; 
            padding: 12px; 
            border-radius: 8px; 
            margin-bottom: 20px; 
        }
        
        .result { 
            margin-top: 20px; 
            padding: 15px; 
            border-radius: 8px; 
            display: none; 
        }
        
        .result.success { 
            background: #f0fff4; 
            color: #22543d; 
            border: 2px solid #68d391; 
        }
        
        .result.error { 
            background: #fed7d7; 
            color: #742a2a; 
            border: 2px solid #fc8181; 
        }
    </style>
</head>
<body>
    <!-- –î–ò–ê–ì–ù–û–°–¢–ò–ß–ï–°–ö–ê–Ø –ü–ê–ù–ï–õ–¨ -->
    <div class="diagnostic" id="diagnostic">
        üîç <strong>–î–ò–ê–ì–ù–û–°–¢–ò–ö–ê CSS</strong><br>
        üìä CSS —Ñ–∞–π–ª: <span id="cssStatus">–ü—Ä–æ–≤–µ—Ä—è–µ–º...</span><br>
        üì± Telegram: <span id="tgStatus">–ü—Ä–æ–≤–µ—Ä—è–µ–º...</span><br>
        üåê URL: <span id="urlInfo"></span><br>
        üìã –°—Ç–∏–ª–∏: <span id="stylesCount">0</span><br>
        ‚è∞ <span id="timestamp"></span>
    </div>

    <div class="container">
        <div class="header">
            <div class="logo">üìö</div>
            <h1 class="title">–ë–∞–∑–∞ –ó–Ω–∞–Ω–∏–π 2.0</h1>
            <p class="subtitle">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç–æ–≤ –ø–æ –ø–∏—Ç–∞–Ω–∏—é</p>
        </div>

        <div class="telegram-note">
            <strong>üì± –í–∞–∂–Ω–æ:</strong> –ü–æ—Å–ª–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è —Ñ–æ—Ä–º—ã –¥–æ—Å—Ç—É–ø –∫ –±–∞–∑–µ –∑–Ω–∞–Ω–∏–π –±—É–¥–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞—Ç—å—Å—è –≤–∞—à–∏–º –¢–ê–ë –¢–∏–º. –ü–æ—Å–ª–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –≤—ã –ø–æ–ª—É—á–∏—Ç–µ –¥–æ—Å—Ç—É–ø –∫ Telegram-–±–æ—Ç—É —Å —É–º–Ω—ã–º –ø–æ–∏—Å–∫–æ–º –∏ –ò–ò-–ø–æ–º–æ—â–Ω–∏–∫–æ–º.
        </div>

        <form id="registrationForm">
            <div class="form-group">
                <label for="fullName">üë§ –§–∞–º–∏–ª–∏—è –∏ –ò–º—è *</label>
                <input type="text" id="fullName" name="fullName" required 
                       maxlength="100" pattern="^[–ê-–Ø–∞-—è–Å—ë\s-]+$"
                       placeholder="–ò–≤–∞–Ω–æ–≤ –ò–≤–∞–Ω">
            </div>

            <div class="form-group">
                <label for="consultantId">üÜî ID –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç–∞ *</label>
                <input type="text" id="consultantId" name="consultantId" required 
                       pattern="^[A-Z0-9]+$" maxlength="20"
                       placeholder="ABC123">
            </div>

            <div class="form-group">
                <label for="city">üèôÔ∏è –ì–æ—Ä–æ–¥ *</label>
                <input type="text" id="city" name="city" required maxlength="100"
                       placeholder="–ú–æ—Å–∫–≤–∞">
            </div>

            <div class="form-group">
                <label for="sponsor">üë®‚Äçüíº –§–∞–º–∏–ª–∏—è –∏ –ò–º—è —Å–ø–æ–Ω—Å–æ—Ä–∞ *</label>
                <input type="text" id="sponsor" name="sponsor" required 
                       pattern="^[–ê-–Ø–∞-—è–Å—ë\s-]+$" maxlength="100"
                       placeholder="–ü–µ—Ç—Ä–æ–≤ –ü–µ—Ç—Ä">
            </div>

            <div class="form-group">
                <label for="tabTeam">üéØ –§–∞–º–∏–ª–∏—è –∏ –ò–º—è –¢–ê–ë –¢–∏–º *</label>
                <input type="text" id="tabTeam" name="tabTeam" required 
                       pattern="^[–ê-–Ø–∞-—è–Å—ë\s-]+$" maxlength="100"
                       placeholder="–°–∏–¥–æ—Ä–æ–≤ –°–∏–¥–æ—Ä">
            </div>

            <div class="required-note">* - –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è</div>

            <div class="button-group">
                <button type="submit" class="submit-btn" id="submitBtn">
                    üöÄ –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è
                </button>
                <button type="button" class="cancel-btn" id="cancelBtn">
                    ‚ùå –û—Ç–º–µ–Ω–∞
                </button>
            </div>
        </form>

        <div id="result" class="result"></div>
    </div>

    <script>
        // –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê –°–ò–°–¢–ï–ú–´
        document.addEventListener('DOMContentLoaded', function() {
            const diagnostic = document.getElementById('diagnostic');
            const cssStatus = document.getElementById('cssStatus');
            const tgStatus = document.getElementById('tgStatus');
            const urlInfo = document.getElementById('urlInfo');
            const stylesCount = document.getElementById('stylesCount');
            const timestamp = document.getElementById('timestamp');
            
            // –í—Ä–µ–º—è –∑–∞–≥—Ä—É–∑–∫–∏
            timestamp.textContent = new Date().toLocaleTimeString();
            
            // URL –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
            urlInfo.textContent = window.location.href.split('/').pop();
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ Telegram WebApp
            if (window.Telegram && window.Telegram.WebApp) {
                tgStatus.innerHTML = '<span style="color: #4ade80">‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç</span>';
            } else {
                tgStatus.innerHTML = '<span style="color: #f87171">‚ùå –ù–µ–¥–æ—Å—Ç—É–ø–µ–Ω</span>';
            }
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ CSS
            setTimeout(() => {
                const cssLink = document.getElementById('mainCSS');
                const sheetsCount = document.styleSheets.length;
                stylesCount.textContent = sheetsCount;
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—Å—Ç—å –ª–∏ –æ—Å–Ω–æ–≤–Ω—ã–µ CSS –ø—Ä–∞–≤–∏–ª–∞
                const testElement = document.createElement('div');
                testElement.className = 'container';
                document.body.appendChild(testElement);
                
                const computedStyle = window.getComputedStyle(testElement);
                const backgroundColor = computedStyle.backgroundColor;
                
                document.body.removeChild(testElement);
                
                if (backgroundColor === 'rgb(45, 47, 80)' || sheetsCount > 1) {
                    cssStatus.innerHTML = '<span style="color: #4ade80">‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω</span>';
                } else {
                    cssStatus.innerHTML = '<span style="color: #f87171">‚ùå –ù–µ –∑–∞–≥—Ä—É–∂–µ–Ω</span>';
                    
                    // –ü–æ–ø—ã—Ç–∫–∞ –ø—Ä—è–º–æ–π –∑–∞–≥—Ä—É–∑–∫–∏
                    fetch('../assets/css/bz2-common.css')
                        .then(response => {
                            if (response.ok) {
                                cssStatus.innerHTML = '<span style="color: #fbbf24">‚ö†Ô∏è –§–∞–π–ª –µ—Å—Ç—å, –Ω–æ –Ω–µ –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è</span>';
                            } else {
                                cssStatus.innerHTML = '<span style="color: #f87171">‚ùå –§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω (' + response.status + ')</span>';
                            }
                        })
                        .catch(error => {
                            cssStatus.innerHTML = '<span style="color: #f87171">‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</span>';
                        });
                }
            }, 1000);
            
            // –°–∫—Ä—ã—Ç—å –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É —á–µ—Ä–µ–∑ 10 —Å–µ–∫—É–Ω–¥
            setTimeout(() => {
                diagnostic.style.display = 'none';
            }, 10000);
        });
        
        const WEBHOOK_URL = 'https://n8napps.online/webhook/bz2-user-registration';
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram WebApp
        let tg = window.Telegram?.WebApp;
        let user = tg?.initDataUnsafe?.user;
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ –æ—Ç–º–µ–Ω—ã
        document.getElementById('cancelBtn').addEventListener('click', function() {
            if (tg) {
                tg.close();
            } else {
                window.history.back();
            }
        });
        
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω–æ
        if (user) {
            console.log('üì± Telegram –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:', user);
        }
        
        document.getElementById('registrationForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const submitBtn = document.getElementById('submitBtn');
            const result = document.getElementById('result');
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ Telegram WebApp
            if (!user?.id) {
                result.className = 'result error';
                result.innerHTML = '<strong>‚ùå –û—à–∏–±–∫–∞:</strong> –§–æ—Ä–º–∞ –¥–æ–ª–∂–Ω–∞ –æ—Ç–∫—Ä—ã–≤–∞—Ç—å—Å—è –∏–∑ Telegram –±–æ—Ç–∞';
                result.style.display = 'block';
                return;
            }
            
            // –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ UI
            submitBtn.disabled = true;
            submitBtn.innerHTML = '‚è≥ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º...';
            result.style.display = 'none';
            
            // –°–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö —Ñ–æ—Ä–º—ã (—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Å—Ö–µ–º–µ BZ2_User_Registration)
            const formData = {
                fullname: document.getElementById('fullName').value.trim(),
                id: document.getElementById('consultantId').value.trim().toUpperCase(),
                city: document.getElementById('city').value.trim(),
                sponsor: document.getElementById('sponsor').value.trim(),
                tab: document.getElementById('tabTeam').value.trim(),
                tgid: user.id,
                username: user.username || null
            };

            console.log('üì§ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:', formData);

            try {
                const response = await fetch(WEBHOOK_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                });

                console.log(`üìä Response status: ${response.status}`);
                const data = await response.json();
                console.log('üì• –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞:', data);

                if (response.ok && data.success) {
                    result.className = 'result success';
                    result.innerHTML = `
                        <strong>‚úÖ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞!</strong><br><br>
                        üë§ ${formData.fullname}<br>
                        üÜî ID: ${formData.id}<br>
                        üèôÔ∏è ${formData.city}<br>
                        üéØ –¢–ê–ë –¢–∏–º: ${formData.tab}<br><br>
                        <strong>‚è≥ –û–∂–∏–¥–∞–π—Ç–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è</strong><br>
                        –í–∞—à –¢–ê–ë –¢–∏–º –ø–æ–ª—É—á–∏—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∏ –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç –¥–æ—Å—Ç—É–ø –∫ –±–∞–∑–µ –∑–Ω–∞–Ω–∏–π.
                    `;
                    
                    // –û—á–∏—Å—Ç–∫–∞ —Ñ–æ—Ä–º—ã –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
                    document.getElementById('registrationForm').reset();
                    
                    // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ Telegram WebApp –æ —É—Å–ø–µ—Ö–µ
                    if (tg) {
                        tg.showAlert('‚úÖ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞! –û–∂–∏–¥–∞–π—Ç–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –æ—Ç –¢–ê–ë –¢–∏–º.');
                    }
                    
                } else {
                    throw new Error(data.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞');
                }

            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:', error);
                result.className = 'result error';
                result.innerHTML = `
                    <strong>‚ùå –û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</strong><br>
                    ${error.message}<br><br>
                    –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤–≤–µ–¥–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.
                `;
                
                // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ Telegram WebApp –æ–± –æ—à–∏–±–∫–µ
                if (tg) {
                    tg.showAlert('‚ùå –û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: ' + error.message);
                }
                
            } finally {
                // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ UI
                submitBtn.disabled = false;
                submitBtn.innerHTML = 'üöÄ –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è';
                result.style.display = 'block';
                
                // –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—É
                result.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }
        });

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ Consultant ID –≤ –≤–µ—Ä—Ö–Ω–∏–π —Ä–µ–≥–∏—Å—Ç—Ä
        document.getElementById('consultantId').addEventListener('input', function(e) {
            e.target.value = e.target.value.toUpperCase();
        });

        console.log('üìö –î–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–∞—è —Ñ–æ—Ä–º–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –ë–ó 2.0 –∑–∞–≥—Ä—É–∂–µ–Ω–∞');
        console.log('üì° Webhook URL:', WEBHOOK_URL);
        console.log('üì± Telegram WebApp:', !!user ? '–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω' : '–Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω');
        
        // –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê CSS –ü–†–û–ë–õ–ï–ú
        window.addEventListener('load', function() {
            console.log('üîç –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê CSS:');
            console.log('üìä –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç–∏–ª–µ–π:', document.styleSheets.length);
            console.log('üìÅ CSS –ø—É—Ç—å:', '../assets/css/bz2-common.css');
            console.log('üåê –ë–∞–∑–æ–≤—ã–π URL:', window.location.href);
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å CSS —Ñ–∞–π–ª–∞
            const cssUrl = new URL('../assets/css/bz2-common.css', window.location.href);
            console.log('üîó –ü–æ–ª–Ω—ã–π CSS URL:', cssUrl.href);
            
            fetch(cssUrl.href)
                .then(response => {
                    console.log('üìä CSS Response:', response.status, response.statusText);
                    if (response.ok) {
                        return response.text();
                    }
                    throw new Error(`HTTP ${response.status}`);
                })
                .then(cssText => {
                    console.log('‚úÖ CSS —Ñ–∞–π–ª –∑–∞–≥—Ä—É–∂–µ–Ω, —Ä–∞–∑–º–µ—Ä:', cssText.length, '—Å–∏–º–≤–æ–ª–æ–≤');
                    console.log('üìù –ü–µ—Ä–≤—ã–µ 100 —Å–∏–º–≤–æ–ª–æ–≤:', cssText.substring(0, 100));
                })
                .catch(error => {
                    console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ CSS:', error);
                });
        });
    </script>
</body>
</html>